name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  markdown:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: "**/*.md"

  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: "./scripts"
          severity: warning

  shfmt:
    name: Shell Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install shfmt
        run: |
          wget -O shfmt https://github.com/mvdan/sh/releases/download/v3.12.0/shfmt_v3.12.0_linux_amd64
          chmod +x shfmt
          sudo mv shfmt /usr/local/bin/

      - name: Check shell script formatting
        run: |
          shfmt -d -i 2 -ci scripts/*.sh

  test:
    name: Test Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Test get_follower_history.sh
        run: |
          chmod +x scripts/get_follower_history.sh
          ./scripts/get_follower_history.sh japan yutkat /tmp/test_output.csv
          if [[ ! -f /tmp/test_output.csv ]]; then
            echo "Error: CSV file not created"
            exit 1
          fi
          if [[ ! -s /tmp/test_output.csv ]]; then
            echo "Error: CSV file is empty"
            exit 1
          fi
          echo "✓ get_follower_history.sh test passed"

      - name: Test csv_to_mermaid.sh
        run: |
          chmod +x scripts/csv_to_mermaid.sh
          ./scripts/csv_to_mermaid.sh /tmp/test_output.csv /tmp/test_chart.md "" 10
          if [[ ! -f /tmp/test_chart.md ]]; then
            echo "Error: Chart file not created"
            exit 1
          fi
          if ! grep -q "xychart-beta" /tmp/test_chart.md; then
            echo "Error: Chart file does not contain mermaid chart"
            exit 1
          fi
          echo "✓ csv_to_mermaid.sh test passed"
